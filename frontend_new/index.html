<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>智能学术研究助手</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#4F46E5',
                        secondary: '#EC4899',
                        accent: '#10B981',
                        dark: '#1E293B',
                        light: '#F8FAFC'
                    },
                    fontFamily: {
                        inter: ['Inter', 'sans-serif'],
                    },
                }
            }
        }
    </script>
    <style type="text/tailwindcss">
        @layer utilities {
            .content-auto {
                content-visibility: auto;
            }
            .gradient-text {
                background-clip: text;
                -webkit-background-clip: text;
                color: transparent;
            }
            .glass-effect {
                backdrop-filter: blur(12px);
                -webkit-backdrop-filter: blur(12px);
            }
            .pulse-slow {
                animation: pulse 3s cubic-bezier(0.4, 0, 0.6, 1) infinite;
            }
            .float {
                animation: float 3s ease-in-out infinite;
            }
        }

        @keyframes float {
            0%, 100% {
                transform: translateY(0);
            }
            50% {
                transform: translateY(-10px);
            }
        }

        .research-textarea {
            width: 100%;
            height: 120px;
            padding: 15px;
            background: rgba(30, 41, 59, 0.8);
            border: 2px solid rgba(79, 70, 229, 0.3);
            border-radius: 12px;
            color: white;
            font-size: 16px;
            resize: none;
            margin-bottom: 15px;
            transition: all 0.3s ease;
        }

        .research-textarea:focus {
            outline: none;
            border-color: rgba(79, 70, 229, 0.8);
            box-shadow: 0 0 20px rgba(79, 70, 229, 0.3);
            background: rgba(30, 41, 59, 0.9);
        }

        .research-textarea::placeholder {
            color: rgba(148, 163, 184, 0.7);
        }

        .research-type-select {
            width: 100%;
            padding: 12px 16px;
            background: rgba(30, 41, 59, 0.8);
            border: 2px solid rgba(79, 70, 229, 0.3);
            border-radius: 8px;
            color: white;
            font-size: 14px;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .research-type-select:focus {
            outline: none;
            border-color: rgba(79, 70, 229, 0.8);
            box-shadow: 0 0 15px rgba(79, 70, 229, 0.2);
        }

        .research-type-select option {
            background: rgba(30, 41, 59, 1);
            color: white;
            padding: 8px;
        }

        .input-container {
            margin: 20px 0;
            width: 100%;
        }

        #analyze-btn:not(:disabled):hover {
            transform: scale(1.05);
            box-shadow: 0 10px 25px rgba(16, 185, 129, 0.3);
        }

        #reset-btn:hover {
            transform: scale(1.02);
            box-shadow: 0 5px 15px rgba(71, 85, 105, 0.3);
        }

        #output-container {
            scrollbar-width: thin;
            scrollbar-color: rgba(79, 70, 229, 0.5) transparent;
        }

        #output-container::-webkit-scrollbar {
            width: 6px;
        }

        #output-container::-webkit-scrollbar-track {
            background: transparent;
        }

        #output-container::-webkit-scrollbar-thumb {
            background: rgba(79, 70, 229, 0.5);
            border-radius: 3px;
        }

        #output-container::-webkit-scrollbar-thumb:hover {
            background: rgba(79, 70, 229, 0.7);
        }
    </style>
</head>
<body class="bg-gradient-to-br from-dark to-slate-900 text-light min-h-screen font-inter overflow-x-hidden">
    <div id="particles-js" class="fixed inset-0 z-0 opacity-30"></div>

    <div class="relative z-10 container mx-auto px-4 py-8 max-w-6xl">
        <header class="text-center mb-12">
            <h1 class="text-[clamp(2.5rem,5vw,4rem)] font-bold mb-4 gradient-text bg-gradient-to-r from-primary to-secondary">
                智能学术研究助手
            </h1>
            <p class="text-slate-300 text-lg max-w-2xl mx-auto">
                输入您的研究问题，获取专业的学术分析和建议
            </p>
        </header>

        <main class="bg-dark/50 glass-effect rounded-2xl shadow-2xl p-8 mb-12 border border-white/10">
            <section class="mb-12">
                <div id="drop-area" class="border-2 border-dashed border-primary/50 rounded-xl p-10 text-center cursor-pointer transition-all duration-300 hover:border-primary/80 hover:bg-primary/5">
                    <div class="upload-icon mb-4 text-5xl text-primary/80 float">
                        <i class="fa fa-edit"></i>
                    </div>
                    <h3 class="text-xl font-semibold mb-2">输入您的研究问题</h3>
                    <div class="input-container mb-6">
                        <textarea
                            id="research-input"
                            class="w-full h-32 p-4 bg-slate-800 border border-slate-600 rounded-lg text-white placeholder-slate-400 focus:border-primary focus:outline-none resize-none mb-4"
                            placeholder="请输入您的研究问题或学术查询..."
                        ></textarea>
                        <select id="research-type" class="bg-slate-800 border border-slate-600 rounded-lg px-4 py-2 text-white focus:border-primary focus:outline-none">
                            <option value="general">一般学术查询</option>
                            <option value="literature">文献综述</option>
                            <option value="analysis">数据分析</option>
                            <option value="methodology">研究方法</option>
                        </select>
                    </div>
                    <p class="mt-4 text-sm text-slate-500">支持中英文学术问题查询</p>
                </div>
            </section>

            <section class="mb-12 flex flex-col sm:flex-row justify-center gap-4">
                <button id="analyze-btn" class="bg-gradient-to-r from-accent to-green-500 text-white font-bold py-4 px-12 rounded-full text-lg transition-all duration-300 transform hover:scale-105 hover:shadow-lg flex items-center justify-center gap-2 opacity-70 cursor-not-allowed" disabled>
                    <i class="fa fa-search"></i>
                    <span>开始研究</span>
                </button>
                <button id="reset-btn" class="bg-slate-700 hover:bg-slate-600 text-white font-medium py-4 px-12 rounded-full transition-all duration-300 flex items-center justify-center gap-2">
                    <i class="fa fa-refresh"></i>
                    <span>重置</span>
                </button>
            </section>

            <section>
                <div class="border border-slate-700 rounded-xl overflow-hidden bg-slate-900/80">
                    <div class="bg-slate-800 px-4 py-3 border-b border-slate-700 flex items-center">
                        <div class="flex gap-2 mr-4">
                            <div class="w-3 h-3 rounded-full bg-red-500"></div>
                            <div class="w-3 h-3 rounded-full bg-yellow-500"></div>
                            <div class="w-3 h-3 rounded-full bg-green-500"></div>
                        </div>
                        <h3 class="font-medium">研究结果</h3>
                    </div>
                    <div id="output-container" class="p-4 h-64 overflow-y-auto font-mono text-sm text-green-400 bg-slate-900/90">
                        <p>等待输入研究问题并点击"开始研究"按钮...</p>
                    </div>
                </div>
            </section>
        </main>

        <footer class="text-center text-slate-500 text-sm">
            <p>© 2025 智能学术研究助手 | 基于NVIDIA NeMo Agent Toolkit</p>
        </footer>
    </div>

    <div id="loading-modal" class="fixed inset-0 z-50 flex items-center justify-center bg-black/70 hidden">
        <div class="bg-slate-800 rounded-xl p-8 max-w-md w-full mx-4 border border-slate-700 shadow-2xl">
            <div class="text-center">
                <div class="inline-block animate-spin rounded-full h-16 w-16 border-4 border-primary border-t-transparent mb-4"></div>
                <h3 class="text-xl font-semibold mb-2">正在分析您的研究问题...</h3>
                <p class="text-slate-400">这可能需要一些时间，请耐心等待</p>
                <div class="mt-6">
                    <div class="h-2 bg-slate-700 rounded-full overflow-hidden">
                        <div id="progress-bar" class="h-full bg-gradient-to-r from-primary to-secondary w-0 transition-all duration-300"></div>
                    </div>
                    <p id="progress-text" class="mt-2 text-sm text-slate-400">准备中...</p>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/particles.js/2.0.0/particles.min.js"></script>
    <script>
        particlesJS('particles-js', {
            "particles": {
                "number": {
                    "value": 80,
                    "density": {
                        "enable": true,
                        "value_area": 800
                    }
                },
                "color": {
                    "value": "#4F46E5"
                },
                "shape": {
                    "type": "circle",
                },
                "opacity": {
                    "value": 0.5,
                    "random": true
                },
                "size": {
                    "value": 3,
                    "random": true
                },
                "line_linked": {
                    "enable": true,
                    "distance": 150,
                    "color": "#4F46E5",
                    "opacity": 0.2,
                    "width": 1
                },
                "move": {
                    "enable": true,
                    "speed": 1,
                    "direction": "none",
                    "random": true,
                    "straight": false,
                    "out_mode": "out",
                    "bounce": false
                }
            },
            "interactivity": {
                "detect_on": "canvas",
                "events": {
                    "onhover": {
                        "enable": true,
                        "mode": "grab"
                    },
                    "onclick": {
                        "enable": true,
                        "mode": "push"
                    },
                    "resize": true
                },
                "modes": {
                    "grab": {
                        "distance": 140,
                        "line_linked": {
                            "opacity": 0.5
                        }
                    },
                    "push": {
                        "particles_nb": 3
                    }
                }
            },
            "retina_detect": true
        });

        // 元素引用
        const researchInput = document.getElementById('research-input');
        const researchType = document.getElementById('research-type');
        const analyzeBtn = document.getElementById('analyze-btn');
        const resetBtn = document.getElementById('reset-btn');
        const outputContainer = document.getElementById('output-container');

        researchInput.addEventListener('input', function() {
            if (this.value.trim().length > 0) {
                analyzeBtn.disabled = false;
                analyzeBtn.classList.remove('opacity-70', 'cursor-not-allowed');
                outputContainer.innerHTML = '<p>已输入研究问题，点击"开始研究"按钮进行分析...</p>';
            } else {
                analyzeBtn.disabled = true;
                analyzeBtn.classList.add('opacity-70', 'cursor-not-allowed');
                outputContainer.innerHTML = '<p>等待输入研究问题并点击"开始研究"按钮...</p>';
            }
        });

        resetBtn.addEventListener('click', function() {
            researchInput.value = '';
            researchType.value = 'general';
            analyzeBtn.disabled = true;
            analyzeBtn.classList.add('opacity-70', 'cursor-not-allowed');
            outputContainer.innerHTML = '<p>等待输入研究问题并点击"开始研究"按钮...</p>';
        });

        // 辅助函数：追加文本到预格式化容器，首次追加时替换占位
        function makePre() {
            outputContainer.innerHTML = '<pre id="result-pre" style="white-space:pre-wrap; font-family:inherit; color:#93c5fd; line-height:1.5;">⏳ 处理中，请稍候...\n\n</pre>';
            return document.getElementById('result-pre');
        }

        // 解析并处理单个 payload（JSON 或文本）
        function handlePayload(payload, resultPre, state) {
            // payload 可能是 JSON 字符串或纯文本
            let textToAppend = '';
            try {
                const data = JSON.parse(payload);
                // 常见的流式结构——OpenAI-like delta、message、choices
                if (data.choices && data.choices[0]) {
                    const c0 = data.choices[0];
                    if (c0.delta && c0.delta.content) textToAppend = c0.delta.content;
                    else if (c0.text) textToAppend = c0.text;
                    else if (c0.message && (c0.message.content || c0.message)) textToAppend = c0.message.content || c0.message;
                } else if (data.content) {
                    textToAppend = data.content;
                } else if (data.text) {
                    textToAppend = data.text;
                } else {
                    // 将整个 JSON 转为字符串展示（便于调试）
                    textToAppend = JSON.stringify(data);
                }
            } catch (e) {
                // 不是 JSON，直接当文本追加
                textToAppend = payload;
            }

            if (textToAppend) {
                // 如果是第一次有效输出，替换掉占位提示（保持已显示少量前缀）
                if (!state.hadOutput) {
                    // 如果占位是“处理中”，将其替换为第一个片段（不保留占位）
                    resultPre.innerText = textToAppend;
                    state.hadOutput = true;
                } else {
                    resultPre.innerText += textToAppend;
                }
                resultPre.scrollTop = resultPre.scrollHeight;
            }
        }

        // 处理流（兼容 SSE、ndjson、纯分块文本）
        async function processStream(response, resultPre) {
            const reader = response.body.getReader();
            const decoder = new TextDecoder();
            let buffer = '';
            const state = { hadOutput: false };
            try {
                while (true) {
                    const { value, done } = await reader.read();
                    if (done) break;
                    buffer += decoder.decode(value, { stream: true });

                    // 优先尝试按 SSE 事件（以双换行分隔 event）
                    if (buffer.includes('\n\n')) {
                        const parts = buffer.split('\n\n');
                        // 保留最后一个可能不完整的块到 buffer
                        buffer = parts.pop();
                        for (const part of parts) {
                            const lines = part.split(/\r?\n/).map(l => l.trim()).filter(l => l !== '');
                            // 收集 data: 行
                            const dataLines = lines.filter(l => l.startsWith('data:'));
                            if (dataLines.length > 0) {
                                const payload = dataLines.map(l => l.replace(/^data:\s*/, '')).join('\n');
                                if (payload === '[DONE]') {
                                    return state;
                                }
                                handlePayload(payload, resultPre, state);
                            } else {
                                // 如果没有 data: 行，有可能直接是文本/JSON
                                const joined = lines.join('\n');
                                if (joined === '[DONE]') return state;
                                handlePayload(joined, resultPre, state);
                            }
                        }
                    }

                    // 其次处理按行分隔（ndjson）
                    if (!buffer.includes('\n\n') && buffer.includes('\n')) {
                        const lines = buffer.split(/\r?\n/);
                        // 最后一行可能不完整，保留它
                        buffer = lines.pop();
                        for (const line of lines) {
                            const trimmed = line.trim();
                            if (!trimmed) continue;
                            if (trimmed === '[DONE]') return state;
                            handlePayload(trimmed, resultPre, state);
                        }
                    }

                    // 如果缓冲区很大且不包含换行，尝试当作纯文本片段追加（防止卡住）
                    if (buffer.length > 2000) {
                        handlePayload(buffer, resultPre, state);
                        buffer = '';
                    }
                }

                // 处理遗留缓冲
                const leftover = buffer.trim();
                if (leftover && leftover !== '[DONE]') {
                    handlePayload(leftover, resultPre, state);
                }
                return state;
            } finally {
                // 关闭 reader
                try { reader.releaseLock(); } catch (e) {}
            }
        }

        // 主按钮逻辑：调用 /chat/stream 并使用 processStream 进行实时显示
        analyzeBtn.addEventListener('click', async function() {
            const question = researchInput.value.trim();
            const type = researchType.value;

            if (!question || analyzeBtn.disabled) return;

            analyzeBtn.disabled = true;
            analyzeBtn.classList.add('opacity-70', 'cursor-not-allowed');
            const resultPre = makePre();

            const requestData = {
                messages: [
                    {
                        role: "user",
                        content: `研究类型: ${type}\n问题: ${question}`
                    }
                ],
                stream: true
            };

            try {
                // const response = await fetch('/chat/stream', {
                //     method: 'POST',
                //     headers: { 'Content-Type': 'application/json' },
                //     body: JSON.stringify(requestData)
                // });

                // 只过滤显示 LLM_END 和 TOOL_END 事件，减少中间步骤干扰
                const response = await fetch('/chat/stream?filter_steps=LLM_END,TOOL_END', {  
                    method: 'POST',  
                    headers: { 'Content-Type': 'application/json; charset=utf-8' },
                    body: JSON.stringify(requestData)  
                });

                if (!response.ok) {
                    const text = await response.text().catch(()=> '');
                    resultPre.innerText = `❌ 请求失败: ${response.status} ${response.statusText}\n\n${text}`;
                    return;
                }

                // 处理流
                const state = await processStream(response, resultPre);

                // 如果没有任何有效输出，提示用户查看日志或尝试刷新
                if (!state.hadOutput) {
                    resultPre.innerText = '⚠️ 未收到中间输出，已接收完流。请检查后端是否支持流或检查服务器日志。';
                } else {
                    resultPre.innerText += '\n\n✅ 分析完成！';
                }
            } catch (err) {
                console.error('Stream error:', err);
                resultPre.innerText += `\n\n❌ 错误: ${err.message || String(err)}`;
            } finally {
                analyzeBtn.disabled = false;
                analyzeBtn.classList.remove('opacity-70', 'cursor-not-allowed');
            }
        });
    </script>
</body>
</html>